# -*- coding: utf-8 -*-
"""Untitled6.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1TBC-SKKNm03PJIe45Bwr-EUiC-DZ-wdw
"""

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
src/gis_loader.py
GISãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•èª­ã¿è¾¼ã¿å°‚ç”¨ã‚¯ãƒ©ã‚¹
"""

import streamlit as st
import requests
from config.settings import GIS_CONFIG
from src.file_processors import FileProcessor

class GISAutoLoader:
    """GISãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•èª­ã¿è¾¼ã¿ã‚¯ãƒ©ã‚¹"""

    def __init__(self, github_api):
        self.github_api = github_api
        self.file_processor = FileProcessor()

    def auto_load_by_code(self, prefecture_code: str, city_code: str) -> bool:
        """5æ¡ã‚³ãƒ¼ãƒ‰ã§GISãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿"""
        search_code = f"{prefecture_code}{city_code}"

        # æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        if self._is_already_loaded(search_code):
            return True

        # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
        found_files = self._search_files(search_code)

        if not found_files:
            self._clear_gis_data()
            return False

        # æœ€å„ªå…ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        return self._load_priority_file(found_files[0], search_code)
        
        def auto_load_by_code(self, prefecture_code: str, city_code: str) -> bool:
            """5æ¡ã‚³ãƒ¼ãƒ‰ã§GISãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿"""
            search_code = f"{prefecture_code}{city_code}"
    
            st.write(f"ğŸ” GISãƒ­ãƒ¼ãƒ€ãƒ¼é–‹å§‹: {search_code}")

            # æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if self._is_already_loaded(search_code):
                st.write("âœ… æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿")
                return True

            # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
            st.write("ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢é–‹å§‹...")
            found_files = self._search_files(search_code)
            st.write(f"ğŸ“„ æ¤œç´¢çµæœ: {len(found_files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«")
    
            # è¦‹ã¤ã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°è¡¨ç¤º
            for i, file_info in enumerate(found_files):
                st.write(f"  ãƒ•ã‚¡ã‚¤ãƒ«{i+1}: {file_info.get('name', 'Unknown')}")

            if not found_files:
                st.warning("âš ï¸ ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                self._clear_gis_data()
                return False

            # æœ€å„ªå…ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            st.write(f"ğŸ“¥ å„ªå…ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿: {found_files[0].get('name', 'Unknown')}")
            result = self._load_priority_file(found_files[0], search_code)
            st.write(f"ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿çµæœ: {result}")
    
            return result

    def _is_already_loaded(self, search_code: str) -> bool:
        """æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯"""
        current_code = st.session_state.get('current_gis_code', '')
        return current_code == search_code

    def _search_files(self, search_code: str) -> list:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
        gis_folder = GIS_CONFIG.get('default_gis_folder', '')
        if not gis_folder:
            return []

        return GISFileSearcher(self.github_api).search(gis_folder, search_code)
        
        def _search_files(self, search_code: str) -> list:
            """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
            gis_folder = GIS_CONFIG.get('default_gis_folder', '')
            st.write(f"ğŸ” æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€: {gis_folder}")
    
            if not gis_folder:
                st.error("âŒ GISãƒ•ã‚©ãƒ«ãƒ€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
                return []

            searcher = GISFileSearcher(self.github_api)
            found_files = searcher.search(gis_folder, search_code)
            st.write(f"ğŸ“„ æ¤œç´¢çµæœ: {len(found_files)}å€‹")
    
            return found_files

    def _load_priority_file(self, file_info: dict, search_code: str) -> bool:
        """å„ªå…ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
        try:
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            response = requests.get(
                file_info['download_url'],
                headers=self.github_api.headers,
                timeout=30
            )
            response.raise_for_status()

            # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
            success = self.file_processor.process_file(
                response.content,
                file_info['name'],
                file_info['extension']
            )

            if success:
                st.session_state.current_gis_code = search_code
                st.session_state.selected_file_path = file_info['name']
                return True

            return False

        except Exception as e:
            st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return False

    def _clear_gis_data(self):
        """GISãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢"""
        st.session_state.area_data = {}
        st.session_state.selected_oaza = ""
        st.session_state.selected_chome = ""
        st.session_state.selected_file_path = ""

class GISFileSearcher:
    """GISãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢å°‚ç”¨ã‚¯ãƒ©ã‚¹"""

    def __init__(self, github_api):
        self.github_api = github_api

    def search(self, folder_url: str, search_code: str) -> list:
        """ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
        try:
            api_url = self.github_api._convert_folder_url_to_api(folder_url)
            response = requests.get(api_url, headers=self.github_api.headers, timeout=30)

            if response.status_code != 200:
                return []

            files_data = response.json()
            return self._filter_matching_files(files_data, search_code)

        except Exception as e:
            st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return []

    def _filter_matching_files(self, files_data: list, search_code: str) -> list:
        """ãƒãƒƒãƒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°"""
        gis_extensions = GIS_CONFIG.get('supported_extensions', [])
        found_files = []

        for file_info in files_data:
            if file_info['type'] == 'file':
                file_name = file_info['name']
                file_ext = '.' + file_name.lower().split('.')[-1] if '.' in file_name else ''

                if search_code in file_name and file_ext in gis_extensions:
                    found_files.append({
                        'name': file_name,
                        'download_url': file_info['download_url'],
                        'size': file_info.get('size', 0),
                        'extension': file_ext
                    })

        # å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
        priority_order = {'.zip': 1, '.csv': 2, '.xlsx': 2, '.xls': 2, '.shp': 3, '.kml': 4}
        return sorted(found_files, key=lambda x: priority_order.get(x['extension'], 99))

    def _search_files(self, search_code: str) -> list:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
        gis_folder = GIS_CONFIG.get('default_gis_folder', '')
        st.write(f"ğŸ” ãƒ•ã‚©ãƒ«ãƒ€URL: {gis_folder}")
    
        if not gis_folder:
            st.error("âŒ GISãƒ•ã‚©ãƒ«ãƒ€ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            return []

        searcher = GISFileSearcher(self.github_api)
        found_files = searcher.search(gis_folder, search_code)
        st.write(f"ğŸ“„ è¦‹ã¤ã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(found_files)}")
    
        return found_files
        
    def search(self, folder_url: str, search_code: str) -> list:
        """ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
        try:
            st.write(f"ğŸŒ API URL: {folder_url}")
        
            # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
            response = requests.get(folder_url, headers=self.github_api.headers, timeout=30)
            st.write(f"ğŸ“¡ APIå¿œç­”ã‚³ãƒ¼ãƒ‰: {response.status_code}")

            if response.status_code != 200:
                st.error(f"âŒ APIå¿œç­”ã‚¨ãƒ©ãƒ¼: {response.status_code}")
                st.error(f"ã‚¨ãƒ©ãƒ¼å†…å®¹: {response.text[:200]}...")
                return []

            files_data = response.json()
            st.write(f"ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€å†…ãƒ•ã‚¡ã‚¤ãƒ«ç·æ•°: {len(files_data)}")
        
            # ãƒ•ã‚¡ã‚¤ãƒ«åä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆæœ€åˆã®5å€‹ã¾ã§ï¼‰
            for i, file_info in enumerate(files_data[:5]):
                if file_info['type'] == 'file':
                    st.write(f"  ğŸ“„ {file_info['name']}")
        
            if len(files_data) > 5:
                st.write(f"  ... ä»–{len(files_data)-5}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«")

            filtered_files = self._filter_matching_files(files_data, search_code)
            st.write(f"ğŸ¯ æ¡ä»¶ä¸€è‡´ãƒ•ã‚¡ã‚¤ãƒ«: {len(filtered_files)}å€‹")
        
            return filtered_files

        except Exception as e:
            st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return []
